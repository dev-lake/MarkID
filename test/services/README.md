# 水印功能测试文档

## 概述

本目录包含了 `Watermark` 类的完整测试套件，用于验证水印功能的正确性、性能和稳定性。

## 测试文件结构

```
test/services/
├── watermark_test.dart              # 基础功能测试
├── watermark_integration_test.dart  # 集成测试
├── run_watermark_tests.dart         # 测试运行脚本
├── test_config.dart                 # 测试配置文件
└── README.md                        # 本文档
```

## 测试覆盖范围

### 1. 基础功能测试 (`watermark_test.dart`)

#### 图片加载测试
- ✅ 加载有效的图片数据
- ✅ 处理空数据异常

#### 水印类型1测试 (显性水印)
- ✅ 添加文字水印
- ✅ 处理空字符串水印
- ✅ 处理长文本水印

#### 水印类型2测试 (渐变水印)
- ✅ 添加渐变水印
- ✅ 使用自定义参数
- ✅ 处理空字符串水印
- ✅ 处理异常情况

#### 边界条件测试
- ✅ 处理极小的图片
- ✅ 处理特殊字符水印

#### 性能测试
- ✅ 验证处理时间在合理范围内

### 2. 集成测试 (`watermark_integration_test.dart`)

#### 实际使用场景测试
- ✅ 证件照片显性水印添加
- ✅ 证件照片暗水印添加
- ✅ 大尺寸图片水印处理
- ✅ 批量水印处理

#### 水印参数测试
- ✅ 不同透明度设置 (0.1 - 0.9)
- ✅ 不同角度设置 (0° - 90°)
- ✅ 不同行列设置 (1x1 到 6x4)

#### 错误处理测试
- ✅ 处理损坏的图片数据
- ✅ 处理超大文本 (1000字符)
- ✅ 处理Unicode字符

#### 性能基准测试
- ✅ 小图片处理性能 (< 2秒)
- ✅ 大图片处理性能 (< 5秒)
- ✅ 连续处理性能 (< 10秒)

#### 水印效果验证
- ✅ 验证水印文本内容
- ✅ 不同类型水印对比

## 运行测试

### 运行所有水印测试
```bash
flutter test test/services/
```

### 运行特定测试文件
```bash
# 运行基础功能测试
flutter test test/services/watermark_test.dart

# 运行集成测试
flutter test test/services/watermark_integration_test.dart
```

### 运行特定测试组
```bash
# 运行性能测试
flutter test test/services/watermark_integration_test.dart --name="性能基准测试"

# 运行错误处理测试
flutter test test/services/watermark_integration_test.dart --name="错误处理测试"
```

## 测试配置

测试配置在 `test_config.dart` 文件中定义，包括：

- 测试图片尺寸
- 性能测试时间限制
- 测试水印文本
- 测试参数范围
- 特殊字符测试文本

## 测试辅助函数

`run_watermark_tests.dart` 中提供了测试辅助函数：

- `validateWatermarkedImage()` - 验证水印图片基本属性
- `validateImageSizeChange()` - 验证图片大小变化
- `validateProcessingTime()` - 验证处理时间

## 测试数据

测试使用程序生成的图片数据，包括：

- 小尺寸测试图片 (100x100)
- 中等尺寸测试图片 (300x300)
- 大尺寸测试图片 (500x500)
- 损坏的图片数据

## 性能基准

当前测试的性能基准：

- 小图片处理: < 2秒
- 中等图片处理: < 3秒
- 大图片处理: < 5秒
- 批量处理 (5次): < 10秒

## 注意事项

1. **测试环境**: 测试需要在 Flutter 测试环境中运行
2. **图片生成**: 测试使用程序生成的图片，不依赖外部文件
3. **性能测试**: 性能测试结果可能因设备性能而异
4. **错误处理**: 测试验证了各种异常情况的处理

## 扩展测试

如需添加新的测试，请遵循以下原则：

1. 使用描述性的测试名称
2. 包含适当的断言验证
3. 测试边界条件和异常情况
4. 考虑性能影响
5. 更新本文档

## 故障排除

### 常见问题

1. **测试超时**: 检查设备性能，适当调整时间限制
2. **内存不足**: 减少测试图片尺寸或数量
3. **测试失败**: 检查 Flutter 版本兼容性

### 调试技巧

1. 使用 `flutter test --verbose` 获取详细输出
2. 单独运行失败的测试用例
3. 检查测试环境配置 