# 多照片功能特性说明

## 概述

为证件照片管理应用添加了多张照片支持功能，允许一个证件包含多张照片（如正反面、多页等）。

## 主要功能

### 1. 数据模型更新

#### DocumentPhoto 模型
- 新增 `DocumentPhoto` 模型来表示单张照片
- 支持照片类型、描述、排序、主照片标识等属性
- 包含完整的文件信息和元数据

#### IdDocument 模型更新
- 将单张照片改为照片列表 (`List<DocumentPhoto>`)
- 添加主照片获取方法 (`primaryPhoto`)
- 添加照片排序方法 (`sortedPhotos`)
- 更新文件大小计算为总大小

### 2. 照片管理服务

#### MultiPhotoService
- `addPhotoToDocument()` - 为证件添加单张照片
- `addMultiplePhotosToDocument()` - 批量添加照片
- `removePhotoFromDocument()` - 删除照片
- `setPrimaryPhoto()` - 设置主照片
- `reorderPhotos()` - 重新排序照片
- `updatePhotoInfo()` - 更新照片信息
- `getPhotoStats()` - 获取照片统计信息

### 3. 用户界面

#### PhotoManagementScreen
- 照片列表显示（支持拖拽排序）
- 照片缩略图预览
- 添加新照片功能
- 编辑照片信息
- 删除照片
- 设置主照片
- 照片统计信息显示

#### DocumentDetailScreen 更新
- 支持多张照片的显示
- 主照片大图显示
- 照片缩略图列表
- 照片管理入口
- 照片数量显示

### 4. 数据库升级

#### 数据库版本升级 (v1 -> v2)
- 新增 `photos` 字段存储照片列表
- 自动迁移现有单张照片数据
- 保持向后兼容性

## 使用场景

### 1. 身份证
- 正面照片
- 反面照片
- 可选：内页照片

### 2. 护照
- 封面照片
- 第一页（个人信息页）
- 第二页（签证页）
- 第三页（备注页）
- 其他内页

### 3. 驾驶证
- 正面照片
- 反面照片

### 4. 其他证件
- 支持任意数量的照片
- 自定义照片类型和描述

## 技术特性

### 1. 照片排序
- 使用 `sortIndex` 字段控制显示顺序
- 支持拖拽重新排序
- 自动维护排序索引

### 2. 主照片管理
- 每个证件可以设置一张主照片
- 主照片用于缩略图显示
- 删除主照片时自动选择新的主照片

### 3. 文件管理
- 自动生成缩略图
- 支持原图和缩略图路径
- 删除照片时自动清理文件

### 4. 数据完整性
- 照片删除时自动重新排序
- 主照片删除时自动选择新主照片
- 数据库事务保证数据一致性

## API 使用示例

### 添加照片
```dart
final provider = context.read<DocumentProvider>();
final success = await provider.addPhotoToDocument(
  documentId: 'document_id',
  photoType: '正面',
  description: '身份证正面照片',
);
```

### 设置主照片
```dart
final success = await provider.setPrimaryPhoto(
  documentId: 'document_id',
  photoId: 'photo_id',
);
```

### 重新排序照片
```dart
final success = await provider.reorderPhotos(
  documentId: 'document_id',
  photoIds: ['photo1', 'photo2', 'photo3'],
);
```

### 删除照片
```dart
final success = await provider.removePhotoFromDocument(
  documentId: 'document_id',
  photoId: 'photo_id',
);
```

## 界面导航

### 进入照片管理
1. 在证件详情页面点击"管理照片"按钮
2. 或通过路由 `/photo-management` 传入 `documentId`

### 照片管理界面功能
- 查看所有照片
- 添加新照片（相机/相册）
- 编辑照片信息
- 删除照片
- 设置主照片
- 拖拽排序

## 数据迁移

### 自动迁移
- 应用启动时自动检测数据库版本
- 将现有单张照片数据迁移为多照片格式
- 保持原有数据完整性

### 迁移规则
- 原单张照片转换为 `DocumentPhoto` 对象
- 照片类型设置为"正面"
- 设为主照片
- 排序索引为0

## 性能优化

### 1. 图片加载
- 使用缩略图进行列表显示
- 原图仅在详情页面加载
- 支持图片缓存

### 2. 内存管理
- 及时释放不需要的图片资源
- 使用 `FutureBuilder` 异步加载图片
- 错误处理和重试机制

### 3. 数据库优化
- 照片数据序列化为JSON存储
- 支持索引查询
- 批量操作优化

## 错误处理

### 1. 文件操作
- 文件不存在时的优雅降级
- 权限不足时的用户提示
- 存储空间不足的处理

### 2. 网络操作
- 网络超时处理
- 重试机制
- 离线模式支持

### 3. 用户操作
- 输入验证
- 操作确认对话框
- 错误信息提示

## 未来扩展

### 1. 照片编辑
- 裁剪功能
- 滤镜效果
- 亮度/对比度调整

### 2. 批量操作
- 批量导入照片
- 批量设置标签
- 批量导出

### 3. 智能识别
- OCR文字识别
- 证件类型自动识别
- 照片质量评估

### 4. 云同步
- 照片云端备份
- 多设备同步
- 版本控制

## 测试

### 1. 单元测试
- 模型序列化/反序列化
- 服务层业务逻辑
- 数据迁移逻辑

### 2. 集成测试
- 数据库操作
- 文件系统操作
- UI交互流程

### 3. 性能测试
- 大量照片的加载性能
- 内存使用情况
- 数据库查询性能

## 注意事项

1. **存储空间**: 多张照片会占用更多存储空间，建议定期清理不需要的照片
2. **性能影响**: 照片数量过多可能影响应用性能，建议合理控制照片数量
3. **数据备份**: 重要证件照片建议定期备份
4. **隐私保护**: 照片数据已加密存储，但仍需注意设备安全

## 总结

多照片功能为证件照片管理应用提供了更强大的功能，支持各种复杂证件的完整照片管理需求。通过合理的架构设计和用户界面，提供了良好的用户体验和数据管理能力。 